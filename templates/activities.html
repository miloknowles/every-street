<!DOCTYPE html>
<html lang="en">
  {% include 'head.html' %}
  <body>
    {% include 'navbar.html' %}
    <div class="container-fluid">
      <p class="mt-3 text-muted">Click to fetch newest activities from Strava and add them to our database.
          By default, this checks for activities in the last week.</p>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="full-history-checkbox">
        <label class="form-check-label text-muted" for="full-history-checkbox">
          <p>Scan full history (slower)</p>
        </label>
      </div>
      <button id="fetch-button" class="btn btn-primary" type="button">
        Pull from Strava
      </button>
      <div id="fetch-status"></div>
      <h3 class="mt-3">{{ items|length }} ACTIVITIES FOUND IN DATABASE</h3>
      <ul class="mt-3" style="list-style-type: none; padding-left: 0;">
        {% for item in items|reverse %}
        <li class="activity-listing">
          <a href="https://www.strava.com/activities/{{item['id']}}" target="_blank">
            {{item['id']}}</a>
            | {{'%0.1f'|format(item['distance'] / 1000 * 0.621371)|float}}mi | {{item['name']}}
            | <a href="/action/activity/{{item['id']}}" target="_blank">JSON</a>
        </li>
        {% endfor %}
      </ul>
    </div>
    <script>
      // Control fetch button behavior.
      $('#fetch-button').on('click', function(e) {
        if ($('#fetch-button').hasClass('disabled')) {
          return;
        }

        $('#fetch-button').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Fetching...');
        $('#fetch-button').addClass('disabled');

        // Do stuff here.
        $.ajax({
          url: '/action/pull-activities',
          type: 'GET',
          data: {
            sliding_window: $('#full-history-checkbox').prop('checked') ? 'None' : 'week'
          },
          success: function(r) {
            console.debug(r);

            $('#fetch-status').html(`\
              <div class="alert alert-success mt-3 text-small" role="alert">\
                Found ${r["new_count"]} new, ${r["total_count"]} total. Refresh to see new activities below.\
              </div>`)

            // Reset to the original button state.
            $('#fetch-button').html('Pull from Strava');
            $('#fetch-button').removeClass('disabled');
          },
          error: function(xhr) {
            console.debug(xhr);

            $('#fetch-status').html(`\
              <div class="alert alert-danger mt-3 text-small" role="alert">\
                Server error: ${xhr['responseJSON']['error']}\
              </div>`)

            // Reset to the original button state.
            $('#fetch-button').html('Pull from Strava');
            $('#fetch-button').removeClass('disabled');
          }
        });
      });
    </script>
  </body>
</html>
